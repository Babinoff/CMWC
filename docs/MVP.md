# CMWC (Collision Matrix With Cost) — MVP план реализации

## Цель MVP
- Создать веб-приложение, которое реализует CMWC как интерактивную матрицу.
- Взять для примера базовую «матрицу коллизий» и преобразовать её в CMWC-версию: ячейки переходят от статусов «проверка/дублирование» к метрикам «стоимость устранения».
- Обеспечить UI для отображения стоимости коллизий; парсинг и мэппинг стоимости.
- Использовать данные по стоимости из открытых источников и LLM‑ассистента для формирования данных при заполнении таблиц (с возможностью корректировки пользователем).

## Объем MVP (Scope)
- Базовая матрица коллизий: загружается как при старте проекта, выступая основой для интерфейсов.
- Источники данных: внешние ресурсы расценок, публичные сметные базы, прайс‑листы, ГЭСНр.
- Стоимость: подбор «пакетов работ» для устранения коллизий на уровне ячеек (пар дисциплин) и конкретных коллизий.
- Отчеты: визуализация стоимости на матрице.
- LLM‑ассистент: парсинг данных, генерация предложений стоимости и мэппинга при заполнении таблиц; возможность верификации пользователем и журнал действий.
- Сохранение данных в локальной базе SQLite: таблица матрица коллизий, таблица работ, таблица стоимости, таблица сценариев, таблица журнала запросов.

## Текстовые макеты, описание реализации страниц
- Инициализация: при первом запуске приложения, пользователь загружает базовую матрицу коллизий, на основе которой становятся доступны вкладки «Матрица коллизий» и «Матрица стоимости».
- Веб‑UI: основан на двух главных вкладках «Матрица коллизий» и «Матрица стоимости», вкладки настроек и вкладки журнала запросов (логов)
- Переключение между вкладками осуществляется нажатием по кнопкам расположенным в верхнем уровне приложения. При нажатии на каждую из вкладок, под первым рядом кнопок переключения вкладок появляется второй ряд кнопок управления работой выбранной вкладки. 
- Разрабатываемые вкладки: Матрица коллизий, Матрица стоимости, Настройки, Журнал

- Вкладка «Матрица коллизий»: отображает базовую матрицу (первый столбец и первая строка это оси дисциплины, второй столбец и вторая строка это категории элементов в дисциплинах, ячейки указывают необходима проверка на П - пересечение или Д - дублирование). Главная задача матрицы коллизий в работе приложения, то что она отображает при нажатии на категорию потенциальные затраты которые может категория вызывать. При нажатии на строку категории под матрицей коллизий появляется "таблица работ" для этой категории.
- Вкладка «Матрица коллизий» "Таблица работ" представляет из себя таблицу с полями:
  - Наименование (Название или краткое описание работы по устранению коллизии)
  - Цена (стоимость затрат на произведение работ)
  - Ед. (единицы измерения в стоимости работ, например штуки, метры квадратные, кубические и т.д.)
  - Источник (Uri сайта откуда взята работа, или же указано что заполнено в ручную)
  - Score (предположительная точность совпадения указываемая LLM-ассистентом, от 0 до 1, где 1 это точное совпадение)
  - Действие (Принять, Отклонить, Удалить)
  В данной таблице можно создать/удалить строку и заполнить все данные в ней в ручном режиме, или же Принять/Отклонить предложение LLM-ассистента.
- Кнопки управления вкладкой «Матрица коллизий»: 
  - инпут url поле куда указывается url откуда нужно спарсить затраты. 
  - кнопка «Загрузить работы» приложение пытается спарсить указанный url и заполнить данные по работам/затратам для каждой категории. Загрузка происходит в два этапа.
    - на первом этапе парсер собирает данные с указанного url сохраняя их построчно для каждого найденного вида работ. 
    - на втором этапе происходит итерация по найденным строкам и для каждой строки потенциальных работ, она отправляется LLM-ассистенту, с списком дисциплин-категорий (и пояснением по ним), LLM-ассистент определяет к какой категории можно отнести эту работу указывая предположительный Scope совпадения. В результате парсинга в каждой категории появляется соответствующие строки с данными.
  - кнопка Принять/Отклонить работы со Scope выше указанного. (работы без указанного Scope не обрабатываются)
  - инпут для указания минимального Scope совпадения для принятия работы. (если Scope работы выше или равен указанному, она переводится в статус принятой, иначе в статус отклоненной, при отсутствии Scope работы, она остается в статусе "ожидания")

- Вкладка «Матрица стоимости»: отображает матрицу стоимости устранения коллизий, формой полностью повторяет Матрицу коллизий, но вместо П/Д в ячейках указывается потенциальный диапазхон стоимости устранения коллизий.
- Вкладка «Матрица стоимости» Ячейка матрицы стоимости: отображает диапазон стоимости устранения сценариев (от самого дешевого сценария до самого дорогого) коллизии/наложения категорий элементов, обнаруженный на строительной площадки, стоимость для ячейки подсчитывается по категории элементов строки, суммируя все указанные в ячейки виды работ. То есть для строки КР-Стена, которая пересекается с любым другим столбцом, учитываются стоимости затрат на корректировку именно КР-Стены для устранения коллизии, для строки ОВ - Воздуховод, рассчитывается стоимость перекладки именно трассы воздуховода для обхода остальных элементов и т.д. При нажатии на ячейку под таблицей Матрицы стоимости, появляется таблица Сценариев коллизии. 
- Вкладка «Матрица стоимости» таблица "Сценарии коллизии" отображает возможные сценарии устранения коллизии/наложения категорий элементов, обнаруженных на строительной площадке, с указанием стоимости устранения/наложения для каждого сценария, и представляет из себя таблицу с полями:
  - Наименование (Короткое название сценария)
  - Описание (Описание сценария, например: при монтаже воздуховода было обнаружено что в ЖБ стене не предусмотрено отверстие для прохода воздуховода)
  - Количество работ (Которые необходимо произвести для устранения проектной ошибки на строй площадке, подсчитывает количество применённых работ)
  - Стоимость (Суммарная стоимость работ по устранению коллизии)
- Вкладка «Матрица стоимости» таблица "Сценарии коллизии" заполняется пользователем путём создания сценариев, или же генерируется LLM-ассистентом автоматически на основе данных из Матрицы коллизий, в два этапа 1) генерация Сценариев, 2) подбор работ под Сценарии. Пользователь может редактировать поля Наименование и Описание, как собственные так и созданные LLM-ассистентом, может добавлять и удалять сценарии. 
- Вкладка «Матрица стоимости» таблица "Сценарии коллизии", при нажатии на строку сценария, под таблицей "Сценарии коллизии" открывается таблица "Работы для устранения коллизии"
- Вкладка «Матрица стоимости» таблица "Работы для устранения коллизии" показывает все работы для категории строки в которой находится нажатая ячейка матрицы стоимости. В таблице отображаются поля: Наименование, Цена, Ед, Количество, Сумма, Принять/Отклонить. Наименование, Цена, Ед, берутся непосредственно из работ подобраны в Матрице коллизий, Количество указывает пользователь, Сумма считается умножением цены на количество, Принять/Отклонить определяет используется ли работа при расчёте общей стоимости устранения коллизии.
- Кнопки управления вкладкой «Матрица стоимости: 
  - "Генерировать Сценарии" - LLM-ассистент генерирует Сценарии коллизии на основе категорий строки и столбца, дополнительных данных по дисциплинам категориям.
  - "Подобрать Работы" - LLM-ассистент подбирает-одобряет работы под Сценарии коллизии из доступных для категории работ, заполняет таблицы "Работы для устранения коллизии".

- Вкладка «Настройки»: Содержит три поля ввода для настройки LLM-ассистента:
  - URL провайдера - адрес доступа к провайдеру LLM-ассистента.
  - API ключ - Для подключения к LLM-ассистенту, необходимо получить API-ключ от провайдера (отображается скрыто).
  - Модель - название модели провайдера.
- Вкладка «Журнал»: отображает журнал запросов к LLM-ассистенту, с информацией о дате запроса, времени запроса, названии запроса (под запросом подразумевается нажатие пользователем одной из кнопок инициирующих работу LLM-ассистента), успешности запроса (успешно/не успешно), и в случае не успешного запроса - сообщение об ошибке, количество потраченных токенов на запрос. Также страница отображает общее суммарное количество потраченных токенов на все запросы 

## Краткое описание дисциплин, категорий и их специфики, для работы LLM-ассистента
**РАНГ 1: КР (Конструктив - Несущий)**
* *Элементы:* Колонны, ригели, перекрытия, диафрагмы, несущие стены (ЖБ, монолит).
* *Физический статус:* "Заморожено/Залито".
* *Цена решения за счет этого элемента:* **КАТАСТРОФИЧЕСКАЯ.** Требует разрушения каркаса, Проекта Усиления, экспертизы.
* **ВЫВОД:** Модифицируется только в самом крайнем случае (фундаментальная ошибка проекта).

**РАНГ 2: АР (Архитектура - Ограждающая)**
* *Элементы:* Стены-перегородки (кирпич, блок), Фасады, Витражи, Окна, Двери.
* *Физический статус:* "Построено".
* *Цена решения за счет этого элемента:* **ВЫСОКАЯ.** Требует демонтажа, бурения, вывоза мусора, поставок под заказ, простоя прочих работ.
* **ВЫВОД:** Стоимость модификации в широком диапазоне (от отверстия, сноса стены, до заказа новых фасадных изделий с длительным сроком поставки). Избегать, если возможно. Используется если является самым дешевым решением. 

**РАНГ 3: ВК-Самотек (Gravity Driven)**
* *Элементы:* Канализация (К1, К2), ливнестоки.
* *Физический статус:* "Зависит от гравитации".
* *Цена решения за счет этого элемента:* **ТЕХНОЛОГИЧЕСКИ СЛОЖНАЯ.** Нельзя просто "подвинуть" часть трубы без нарушения уклона всей ветки.
* **ВЫВОД:** Геометрия жестко продиктована физикой. Изменение локального участка практически невозможно — требуется пересчет всей магистрали.

**РАНГ 4: ОВ-Магистрали (Вентиляция)**
* *Элементы:* Крупные воздуховоды, короба.
* *Физический статус:* "Громоздко и Жестко".
* *Цена решения за счет этого элемента:* **СРЕДНЯЯ/ВЫСОКАЯ.** Заказ новых фасонных изделий, простой монтажников.
* **ВЫВОД:** Модификация допустима, но крайне нежелательна из-за логистических задержек (ожидание новых деталей с завода).

**РАНГ 5: Напорные системы (ВК, ОВ, АУПТ)**
* *Элементы:* Водопровод, отопление, спринклеры.
* *Физический статус:* "Гибко под давлением".
* *Цена решения за счет этого элемента:* **УМЕРЕННАЯ.**
* **ВЫВОД:** Стандартный кандидат на изменение трассы. Легко обходит препятствия (Ранги 1-4) с помощью фитингов.

**РАНГ 6: ЭОМ/СС (Кабельные трассы)**
* *Элементы:* Лотки, короба, кабели.
* *Физический статус:* "Максимально гибко".
* *Цена решения за счет этого элемента:* **НИЗКАЯ.**
* **ВЫВОД:** "Донор пространства". Уступает дорогу всем остальным системам. Модифицируется монтажником по месту без затрат на новые детали.

## Архитектура MVP
- Веб‑приложение: SPA.
- Компоненты:
  - Матрица: UI‑интерфейс CMWC‑матрицы (grid/heatmap).
  - Стоимость базовая: парсинг расценок с https://garantstroikompleks.ru/prajs-list
  - LLM‑ассистент: интерпретирует категории элементов матрицы, подбирает соответствующие расценки, генерирует предложения (стоимость, мэппинг) на основе открытых источников; верификация пользователем; журнал и атрибуция источников.
- Хранилище: `SQLite` для MVP (простая установка, переносимость).

## Стек реализации: простой веб-UI
- UI: `React`, сборка `Vite`.